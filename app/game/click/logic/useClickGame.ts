"use client";

import { useState, useEffect, useRef } from "react";

export function useClickGame() {
  const [coins, setCoins] = useState<number>(0);
  const [items, setItems] = useState<(string | null)[]>(Array(7).fill(null));
  const [stockItems, setStockItems] = useState<Record<string, number>>({});
  const [message, setMessage] = useState("");
  const [visible, setVisible] = useState(false);
  const [coinEffect, setCoinEffect] = useState<any>(null);
  const [showSuperFormal, setShowSuperFormal] = useState(false);
  const [showClearButton, setShowClearButton] = useState(false);

  const effectIdRef = useRef(0);
  const coinsRef = useRef(0);

  // -----------------------------
  // â˜… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  // -----------------------------
  const user = JSON.parse(localStorage.getItem("user") || "null");
  const isLoggedIn = !!user?.id;

  // -----------------------------
  // â˜… 1. ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã ã‘ DB ã‹ã‚‰èª­ã¿è¾¼ã‚€
  // -----------------------------
  useEffect(() => {
    const loadData = async () => {
      if (!isLoggedIn) return; // â† ã‚²ã‚¹ãƒˆã¯èª­ã¿è¾¼ã¾ãªã„

      const res = await fetch(`/api/user/${user.id}`);
      const data = await res.json();

      setCoins(data.coins ?? 0);
      setItems(JSON.parse(data.items ?? "[]"));
      setStockItems(JSON.parse(data.stockItems ?? "{}"));
    };

    loadData();
  }, []);

  // coins ãŒå¤‰ã‚ã‚‹ãŸã³ã« ref ã«åæ˜ 
  useEffect(() => {
    coinsRef.current = coins;
  }, [coins]);

  // -----------------------------
  // â˜… 2. ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã ã‘ä¿å­˜ã™ã‚‹
  // -----------------------------
  useEffect(() => {
    if (!isLoggedIn) return; // â† ã‚²ã‚¹ãƒˆã¯ä¿å­˜ã—ãªã„

    const saveOnLeave = () => {
      const payload = JSON.stringify({
        userId: user.id,
        coins: coinsRef.current,
        items,
        stockItems,
      });

      const blob = new Blob([payload], { type: "application/json" });
      navigator.sendBeacon("/api/click/save", blob);
    };

    window.addEventListener("beforeunload", saveOnLeave);

    return () => {
      saveOnLeave();
      window.removeEventListener("beforeunload", saveOnLeave);
    };
  }, [items, stockItems, isLoggedIn]);

  // -----------------------------
  // â˜… 3. ã‚¯ãƒªãƒƒã‚¯
  // -----------------------------
  const getRandomAmount = () => {
    const r = Math.random();
    if (r < 0.7) return 1;
    if (r < 0.9) return 50;
    if (r < 0.99) return 100;
    return 1000;
  };

  const handleClick = () => {
    const amount = getRandomAmount();
    setCoins((prev) => prev + amount);

    setCoinEffect({
      id: effectIdRef.current++,
      value: amount,
      x: 40 + Math.random() * 20,
      y: 40 + Math.random() * 20,
    });
  };

  // -----------------------------
  // â˜… 4. ã‚¬ãƒãƒ£
  // -----------------------------
  const gachaItems = ["ğŸ’¡ãƒãƒ¼ãƒãƒ«", "âœ¨ãƒ¬ã‚¢", "ğŸ‡ã‚¦ãƒ«ãƒˆãƒ©", "ğŸ†ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰"];

  const getRandomItem = () => {
    const r = Math.random();
    if (r < 0.7) return "ğŸ’¡ãƒãƒ¼ãƒãƒ«";
    if (r < 0.9) return "âœ¨ãƒ¬ã‚¢";
    if (r < 0.99) return "ğŸ‡ã‚¦ãƒ«ãƒˆãƒ©";
    return "ğŸ†ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰";
  };

  const handleGacha = (count: number) => {
    const cost = 500 * count;
    if (coins < cost) return showMessage("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");

    const newItems = [...items];
    const newStock = { ...stockItems };
    const results: string[] = [];

    for (let i = 0; i < count; i++) {
      const item = getRandomItem();
      results.push(item);

      const index = newItems.findIndex((v) => v === null);
      if (index !== -1) newItems[index] = item;

      newStock[item] = (newStock[item] || 0) + 1;
    }

    setItems(newItems);
    setStockItems(newStock);
    setCoins(coins - cost);

    const ORDER = ["ğŸ’¡ãƒãƒ¼ãƒãƒ«", "âœ¨ãƒ¬ã‚¢", "ğŸ‡ã‚¦ãƒ«ãƒˆãƒ©", "ğŸ†ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰"];

    const resultCount: Record<string, number> = {};
    for (const item of results) {
      resultCount[item] = (resultCount[item] || 0) + 1;
    }

    const formatted = ORDER.filter((name) => resultCount[name])
      .map((name) => `${name} x${resultCount[name]}`)
      .join(" / ");

    showMessage(`${count}é€£çµæœï¼š${formatted}`);
  };

  // -----------------------------
  // â˜… 5. ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨
  // -----------------------------
  const itemCoinValues: Record<string, number> = {
    "ğŸ’¡ãƒãƒ¼ãƒãƒ«": 100,
    "âœ¨ãƒ¬ã‚¢": 500,
    "ğŸ‡ã‚¦ãƒ«ãƒˆãƒ©": 3000,
    "ğŸ†ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰": 10000,
  };

  const handleUseItem = (itemName: string) => {
    const count = stockItems[itemName] || 0;
    if (count <= 0) return;

    const value = itemCoinValues[itemName];
    const newStock = { ...stockItems };
    newStock[itemName] = count - 1;
    if (newStock[itemName] === 0) delete newStock[itemName];

    setStockItems(newStock);
    setCoins(coins + value);

    showMessage(`${itemName} ã‚’ä½¿ç”¨ã—ã¦ +${value} ã‚³ã‚¤ãƒ³ç²å¾—ï¼`);
  };

  const useAllItemsAllTypes = () => {
    let total = 0;
    for (const name in stockItems) {
      total += (itemCoinValues[name] || 0) * stockItems[name];
    }

    setStockItems({});
    setCoins(coins + total);

    showMessage(`å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ +${total} ã‚³ã‚¤ãƒ³ç²å¾—ï¼`);
  };

  // -----------------------------
  // â˜… 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  // -----------------------------
  const showMessage = (text: string) => {
    setMessage(text);
    setVisible(false);

    setTimeout(() => {
      setVisible(true);
    }, 20);
  };

  // -----------------------------
  // â˜… 7. ã‚¯ãƒªã‚¢æ¼”å‡º
  // -----------------------------
  const handleClear = () => {
    setShowSuperFormal(true);

    setTimeout(() => {
      setShowSuperFormal(false);
      setShowClearButton(true);
    }, 1600);
  };

  return {
    coins,
    items,
    stockItems,
    message,
    visible,
    coinEffect,
    showSuperFormal,
    showClearButton,

    handleClick,
    handleGacha,
    handleUseItem,
    useAllItemsAllTypes,
    handleClear,
    setCoinEffect,
  };
}
